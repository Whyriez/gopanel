<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoPanel Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        [x-cloak] { display: none !important; } /* Sembunyikan elemen sebelum Alpine load */
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans antialiased overflow-hidden"
      x-data="appData()" x-init="initApp()">

<div class="flex h-screen">

    <aside class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col">
        <div class="p-6 flex items-center justify-center border-b border-gray-700">
            <h1 class="text-2xl font-bold text-white tracking-wider"><i class="fas fa-rocket text-blue-500 mr-2"></i>GoPanel</h1>
        </div>

        <nav class="flex-1 px-4 py-6 space-y-2">
            <template x-for="item in menuItems" :key="item.id">
                <button @click="currentTab = item.id"
                        :class="currentTab === item.id ? 'bg-gray-700 text-white border-l-4 border-blue-500' : 'text-gray-300 hover:bg-gray-700 hover:text-white'"
                        class="w-full flex items-center px-4 py-3 rounded-r-lg transition-colors">
                    <i :class="item.icon" class="w-6"></i>
                    <span class="font-medium" x-text="item.label"></span>
                </button>
            </template>
        </nav>

        <div class="p-4 border-t border-gray-700">
            <button @click="logout" class="w-full flex items-center justify-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                <i class="fas fa-sign-out-alt mr-2"></i> Logout
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-gray-800 shadow-sm border-b border-gray-700 py-4 px-6 flex justify-between items-center">
            <h2 class="text-xl font-semibold text-white" x-text="pageTitle"></h2>
            <div class="flex items-center space-x-3">
                <span class="text-sm text-gray-400">Welcome, Admin</span>
                <div class="h-8 w-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold">A</div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6 relative">

            <div x-show="currentTab === 'dashboard'" x-data="statsData()" x-init="startPolling()" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-gray-400 font-medium">CPU Usage</h3>
                            <i class="fas fa-microchip text-blue-500 text-xl"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-white mb-2" x-text="stats.cpu.usage_percent + '%'"></h2>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" :style="`width: ${stats.cpu.usage_percent}%`"></div>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-gray-400 font-medium">RAM Usage</h3>
                            <i class="fas fa-memory text-green-500 text-xl"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-white mb-2" x-text="stats.ram.used"></h2>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div class="bg-green-500 h-2.5 rounded-full transition-all duration-500" :style="`width: ${stats.ram.used_percent}%`"></div>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-gray-400 font-medium">Disk Usage</h3>
                            <i class="fas fa-hdd text-yellow-500 text-xl"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-white mb-2" x-text="stats.disk.used"></h2>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div class="bg-yellow-500 h-2.5 rounded-full transition-all duration-500" :style="`width: ${stats.disk.used_percent}%`"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="currentTab === 'website'" x-data="websiteData()" x-init="loadSites()" class="space-y-6">
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 max-w-2xl">
                    <h3 class="text-lg font-semibold mb-4 border-b border-gray-700 pb-2">Deploy New Website</h3>
                    <form @submit.prevent="createWebsite" class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Domain Name</label>
                            <input type="text" x-model="form.domain" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 focus:ring-blue-500 focus:border-blue-500 text-white" placeholder="example.com" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Type</label>
                                <select x-model="form.type" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 text-white">
                                    <option value="static">HTML Static</option>
                                    <option value="php">PHP (WordPress)</option>
                                    <option value="proxy">NodeJS / Python (Proxy)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Port (Proxy Only)</label>
                                <input type="number" x-model="form.port" :disabled="form.type !== 'proxy'"
                                       :class="form.type === 'proxy' ? 'bg-gray-800 text-white' : 'bg-gray-900 text-gray-500'"
                                       class="w-full border border-gray-600 rounded-lg px-4 py-2 transition-colors" placeholder="Ex: 3000">
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-lg transition-colors">Create Website</button>
                    </form>
                </div>

                <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
                    <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                        <h3 class="font-semibold">Active Websites</h3>
                        <button @click="loadSites" class="text-sm text-blue-400 hover:text-blue-300">Refresh</button>
                    </div>
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-700 text-gray-300">
                        <tr><th class="px-4 py-3">Domain</th><th class="px-4 py-3 text-right">Action</th></tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                        <template x-for="site in sites" :key="site">
                            <tr class="hover:bg-gray-700">
                                <td class="px-4 py-3 text-white">
                                    <a :href="'http://'+site" target="_blank" class="hover:text-blue-400 flex items-center">
                                        <i class="fas fa-external-link-alt mr-2 text-gray-500"></i> <span x-text="site"></span>
                                    </a>
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <button @click="deleteWebsite(site)" class="bg-red-900 hover:bg-red-800 text-red-200 px-3 py-1 rounded text-xs transition">Delete</button>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="sites.length === 0"><td colspan="2" class="px-4 py-3 text-center text-gray-500">No websites found</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div x-show="currentTab === 'files'" x-data="fileManagerData()" x-init="loadFiles()" class="h-full flex flex-col">
                <div class="bg-gray-800 rounded-xl border border-gray-700 flex flex-col flex-1 overflow-hidden shadow-lg">
                    <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800">
                        <div class="flex items-center overflow-hidden">
                            <span class="text-yellow-500 mr-2"><i class="fas fa-folder"></i></span>
                            <span class="text-sm font-mono text-gray-300 truncate" x-text="currentPath || '/ (Root)'"></span>
                        </div>
                        <div class="flex space-x-2">
                            <button @click="goUp()" :disabled="!currentPath" class="px-3 py-1 text-sm bg-gray-700 hover:bg-gray-600 rounded transition disabled:opacity-50"><i class="fas fa-level-up-alt"></i> Up</button>
                            <button @click="loadFiles()" class="px-3 py-1 text-sm bg-blue-600 hover:bg-blue-500 rounded transition"><i class="fas fa-sync"></i></button>
                        </div>
                    </div>
                    <div class="overflow-auto flex-1 bg-gray-900">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-gray-800 text-gray-400 text-xs uppercase sticky top-0">
                            <tr>
                                <th class="px-6 py-3 font-medium">Name</th>
                                <th class="px-6 py-3 font-medium text-right">Size</th>
                                <th class="px-6 py-3 font-medium text-center">Action</th>
                            </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800 text-sm">
                            <template x-for="file in files" :key="file.name">
                                <tr class="hover:bg-gray-700 transition-colors group">
                                    <td class="px-6 py-3">
                                        <a href="#" @click.prevent="file.is_dir ? openDir(file.name) : openFile(file.name)"
                                           class="text-gray-300 hover:text-white flex items-center">
                                            <i :class="file.is_dir ? 'fas fa-folder text-yellow-500' : 'fas fa-file-code text-blue-400'" class="mr-2"></i>
                                            <span x-text="file.name" :class="file.is_dir ? 'font-bold' : ''"></span>
                                        </a>
                                    </td>
                                    <td class="px-6 py-3 text-right text-gray-400 font-mono text-xs" x-text="file.size"></td>
                                    <td class="px-6 py-3 text-center">
                                        <button x-show="!file.is_dir" @click="openFile(file.name)" class="text-gray-500 hover:text-blue-400"><i class="fas fa-edit"></i></button>
                                    </td>
                                </tr>
                            </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div x-show="editor.isOpen" style="display: none;" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-5xl flex flex-col h-[80vh] border border-gray-600">
                        <div class="flex justify-between items-center p-4 border-b border-gray-700">
                            <h5 class="text-lg font-mono text-blue-400 truncate" x-text="editor.filename"></h5>
                            <button @click="editor.isOpen = false" class="text-gray-400 hover:text-white text-xl">&times;</button>
                        </div>
                        <div class="flex-1 relative">
                            <textarea x-model="editor.content" class="w-full h-full bg-gray-900 text-green-400 font-mono p-4 border-none resize-none focus:outline-none text-sm leading-relaxed"></textarea>
                        </div>
                        <div class="p-4 border-t border-gray-700 flex justify-end bg-gray-800 rounded-b-xl">
                            <button @click="editor.isOpen = false" class="mr-3 px-4 py-2 text-gray-300 hover:text-white">Cancel</button>
                            <button @click="saveFile" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded shadow-lg flex items-center"><i class="fas fa-save mr-2"></i> Save Changes</button>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="currentTab === 'database'" x-data="dbManagerData()" x-init="loadDBs()" class="space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl border border-gray-700 h-fit">
                        <h3 class="text-lg font-semibold mb-4 text-yellow-500"><i class="fas fa-plus-circle mr-2"></i>New Database</h3>
                        <form @submit.prevent="createDB" class="space-y-4">
                            <input x-model="form.name" type="text" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="DB Name" required>
                            <input x-model="form.user" type="text" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="DB Username" required>
                            <input x-model="form.pass" type="text" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-white" placeholder="DB Password" required>
                            <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg transition-colors">Create</button>
                        </form>
                    </div>

                    <div class="lg:col-span-2 bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
                        <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                            <h3 class="font-semibold">Database List</h3>
                            <button @click="loadDBs" class="text-sm text-blue-400 hover:text-blue-300">Refresh</button>
                        </div>
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-700 text-gray-300">
                            <tr>
                                <th class="px-4 py-3">Database</th>
                                <th class="px-4 py-3">User</th>
                                <th class="px-4 py-3 text-right">Action</th>
                            </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700">
                            <template x-for="db in databases" :key="db.DBName">
                                <tr class="hover:bg-gray-700">
                                    <td class="px-4 py-3 text-white"><i class="fas fa-database text-gray-500 mr-2"></i><span x-text="db.DBName"></span></td>
                                    <td class="px-4 py-3 text-gray-300" x-text="db.DBUser"></td>
                                    <td class="px-4 py-3 text-right">
                                        <button @click="deleteDB(db.DBName, db.DBUser)" class="bg-red-900 hover:bg-red-800 text-red-200 px-3 py-1 rounded text-xs transition">Delete</button>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="databases.length === 0"><td colspan="3" class="px-4 py-3 text-center text-gray-500">Belum ada database</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div x-show="currentTab === 'users'" x-data="userManagerData()" x-init="loadUsers()" class="space-y-6">
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                    <h3 class="text-lg font-semibold mb-4 text-red-400">User Management</h3>
                    <div class="flex flex-col md:flex-row gap-6">
                        <form @submit.prevent="createUser" class="w-full md:w-1/3 space-y-3 bg-gray-900 p-4 rounded-lg h-fit">
                            <input x-model="form.username" type="text" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white" placeholder="Username" required>
                            <input x-model="form.password" type="password" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white" placeholder="Password" required>
                            <select x-model="form.role" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white">
                                <option value="customer">Customer</option>
                                <option value="admin">Admin</option>
                            </select>
                            <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded transition">Add User</button>
                        </form>
                        <div class="w-full md:w-2/3 overflow-hidden rounded-lg border border-gray-700">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-gray-700 text-gray-300">
                                <tr><th class="px-4 py-2">Username</th><th class="px-4 py-2">Role</th></tr>
                                </thead>
                                <tbody class="divide-y divide-gray-700 bg-gray-800">
                                <template x-for="user in users" :key="user.Username">
                                    <tr class="hover:bg-gray-700">
                                        <td class="px-4 py-3 text-white" x-text="user.Username"></td>
                                        <td class="px-4 py-3">
                                            <span class="px-2 py-1 text-xs rounded" :class="user.Role==='admin'?'bg-red-900 text-red-200':'bg-blue-900 text-blue-200'" x-text="user.Role"></span>
                                        </td>
                                    </tr>
                                </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>
</div>

<script>
    // --- MAIN APP COMPONENT ---
    function appData() {
        return {
            currentTab: 'dashboard',
            userRole: '', // Variable untuk simpan role user saat ini
            username: '',

            // Tambahkan properti 'roles' untuk menentukan siapa yang boleh lihat menu ini
            allMenuItems: [
                {id: 'dashboard', label: 'Dashboard', icon: 'fas fa-tachometer-alt', roles: ['admin', 'customer']},
                {id: 'website', label: 'Websites', icon: 'fas fa-globe', roles: ['admin', 'customer']},
                {id: 'files', label: 'File Manager', icon: 'fas fa-folder-open', roles: ['admin', 'customer']},
                {id: 'database', label: 'Database', icon: 'fas fa-database', roles: ['admin', 'customer']},
                {id: 'users', label: 'Users', icon: 'fas fa-users', roles: ['admin']}, // <--- HANYA ADMIN
            ],

            async initApp() {
                // 1. Cek siapa saya (Panggil API Backend yang baru kita buat)
                try {
                    const res = await fetch('/api/me');
                    if (res.ok) {
                        const data = await res.json();
                        this.userRole = data.role; // Simpan role (admin/customer)
                    } else {
                        // Jika token invalid/expired, tendang ke login
                        window.location.href = '/login';
                    }
                } catch (e) {
                    console.error("Gagal cek user");
                }
            },

            // Getter untuk memfilter menu secara otomatis
            get menuItems() {
                return this.allMenuItems.filter(item => item.roles.includes(this.userRole));
            },

            get pageTitle() {
                const map = {
                    'dashboard': 'Dashboard Overview',
                    'website': 'Website Management',
                    'files': 'File Manager',
                    'database': 'MySQL Databases',
                    'users': 'User Management'
                };
                return map[this.currentTab];
            },

            async logout() {
                await fetch('/api/logout', {method:'POST'});
                window.location.href='/login';
            }
        }
    }

    // --- STATS COMPONENT ---
    function statsData() {
        return {
            stats: {
                cpu: { usage_percent: 0 },
                ram: { used: '0 / 0', used_percent: 0 },
                disk: { used: '0 / 0', used_percent: 0 }
            },
            interval: null,
            async fetchStats() {
                try {
                    const res = await fetch('/api/system-info');
                    this.stats = await res.json();
                } catch(e) {}
            },
            startPolling() {
                this.fetchStats();
                this.interval = setInterval(() => this.fetchStats(), 2000);
            }
        }
    }

    // --- WEBSITE COMPONENT ---
    function websiteData() {
        return {
            form: { domain: '', type: 'static', port: '' },
            sites: [], // Array untuk list website
            async loadSites() {
                try {
                    const res = await fetch('/api/websites');
                    // PERBAIKAN: Tambahkan "|| []" agar kalau null tetap jadi array
                    const data = await res.json();
                    this.sites = data || [];
                } catch(e) {
                    this.sites = [];
                }
            },
            async createWebsite() {
                const res = await fetch('/api/create-website', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify(this.form)
                });
                const result = await res.json();
                if(res.ok) {
                    alert("✅ " + result.message);
                    this.form.domain = ''; this.form.port = '';
                    this.loadSites(); // Reload list setelah create
                }
                else alert("❌ " + result.error);
            },
            async deleteWebsite(domain) {
                if(!confirm("Yakin hapus website " + domain + "? Data tidak bisa kembali!")) return;

                const res = await fetch('/api/delete-website', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({domain: domain})
                });
                if(res.ok) { this.loadSites(); }
                else { alert("Gagal hapus website"); }
            }
        }
    }

    // --- FILE MANAGER COMPONENT ---
    function fileManagerData() {
        return {
            currentPath: '',
            files: [],
            editor: { isOpen: false, content: '', filename: '' },
            async loadFiles(path = null) {
                if(path !== null) this.currentPath = path;
                try {
                    const res = await fetch(`/api/files?path=${encodeURIComponent(this.currentPath)}`);
                    this.files = await res.json();
                } catch(e) { this.files = []; }
            },
            openDir(name) {
                const newPath = this.currentPath ? `${this.currentPath}/${name}` : name;
                this.loadFiles(newPath);
            },
            goUp() {
                if(!this.currentPath) return;
                const parts = this.currentPath.split('/');
                parts.pop();
                this.loadFiles(parts.join('/'));
            },
            async openFile(name) {
                const fullPath = this.currentPath ? `${this.currentPath}/${name}` : name;
                this.editor.filename = fullPath;
                const res = await fetch(`/api/file-content?path=${encodeURIComponent(fullPath)}`);
                const data = await res.json();
                this.editor.content = data.content;
                this.editor.isOpen = true;
            },
            async saveFile() {
                await fetch('/api/save-file', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({path: this.editor.filename, content: this.editor.content})
                });
                alert("File Saved!");
                this.editor.isOpen = false;
            }
        }
    }

    // --- DB COMPONENT ---
    function dbManagerData() {
        return {
            databases: [],
            form: { name: '', user: '', pass: '' },
            async loadDBs() {
                try {
                    const res = await fetch('/api/databases');
                    this.databases = await res.json();
                } catch(e) { this.databases = []; }
            },
            async createDB() {
                // ... (kode create sama seperti sebelumnya) ...
                const payload = { db_name: this.form.name, db_user: this.form.user, db_pass: this.form.pass };
                const res = await fetch('/api/create-database', {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                });
                if(res.ok) { alert("Database Created"); this.form = {name:'', user:'', pass:''}; this.loadDBs(); }
                else alert("Failed");
            },
            async deleteDB(name, user) {
                if(!confirm("Hapus Database " + name + "?")) return;

                const res = await fetch('/api/delete-database', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({db_name: name, db_user: user})
                });

                if(res.ok) { this.loadDBs(); }
                else { alert("Gagal hapus DB"); }
            }
        }
    }

    // --- USER COMPONENT ---
    function userManagerData() {
        return {
            users: [],
            form: { username: '', password: '', role: 'customer' },
            async loadUsers() {
                const res = await fetch('/api/admin/users');
                if(res.ok) this.users = await res.json();
            },
            async createUser() {
                const res = await fetch('/api/admin/create-user', {
                    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(this.form)
                });
                if(res.ok) { alert("User Created"); this.loadUsers(); this.form.username=''; this.form.password=''; }
            }
        }
    }
</script>
</body>
</html>