package services

import (
	"fmt"
	"os"
	"os/exec"
	"path/filepath"
	"text/template"
)

type NginxData struct {
	Domain string
	Type   string
	Port   string
}

func GenerateNginxConfig(domain string, typeSite string, port string) (string, error) {
	// === 1. TENTUKAN PATH ASLI LINUX ===
	// Lokasi config Nginx di VPS (Standard Ubuntu/Debian/CentOS)
	// Kita tambahkan akhiran .conf agar terbaca oleh Nginx (Penting untuk AlmaLinux)
	availablePath := fmt.Sprintf("/etc/nginx/sites-available/%s.conf", domain)
	enabledPath := fmt.Sprintf("/etc/nginx/sites-enabled/%s.conf", domain)

	// Lokasi Folder Website (Root Directory)
	webRoot := fmt.Sprintf("/var/www/%s/public_html", domain)

	// === 2. BIKIN FOLDER WEBSITE ===
	// Sama kayak mkdir -p /var/www/domain.com/public_html
	// Permission 0755 biar bisa dibaca Nginx
	if err := os.MkdirAll(webRoot, 0755); err != nil {
		return "", fmt.Errorf("gagal buat folder webroot: %v", err)
	}

	// === 3. GENERATE INDEX.HTML DARI TEMPLATE (BARU) ===
	// Kita baca dari templates/default_index.html agar tidak hardcoded
	cwd, _ := os.Getwd()
	indexTplPath := filepath.Join(cwd, "templates", "default_index.html")
	indexParams := NginxData{Domain: domain} // Data untuk dikirim ke HTML

	// Cek apakah file template ada?
	indexTpl, err := template.ParseFiles(indexTplPath)
	if err != nil {
		// FALLBACK: Jika template tidak ditemukan, buat file sederhana (Hardcoded)
		// Ini jaga-jaga biar website gak error 403/404 kalau file template hilang
		fallbackContent := fmt.Sprintf("<h1>Welcome to %s</h1><p>Generated by GoPanel</p>", domain)
		os.WriteFile(filepath.Join(webRoot, "index.html"), []byte(fallbackContent), 0644)
	} else {
		// UTAMA: Gunakan template
		indexFile, errCreate := os.Create(filepath.Join(webRoot, "index.html"))
		if errCreate == nil {
			indexTpl.Execute(indexFile, indexParams)
			indexFile.Close()
		}
	}

	// === 4. UPDATE PERMISSION (CHOWN) ===
	// Folder web harus milik 'nginx' (AlmaLinux) atau 'www-data' (Ubuntu)
	// Kita coba ubah ke 'nginx' dulu karena kamu pakai AlmaLinux.
	// Kalau error, script lanjut aja (gak fatal).
	cmdChown := exec.Command("chown", "-R", "nginx:nginx", fmt.Sprintf("/var/www/%s", domain))
	if err := cmdChown.Run(); err != nil {
		// Fallback ke www-data kalau user nginx gak ada (untuk Ubuntu)
		exec.Command("chown", "-R", "www-data:www-data", fmt.Sprintf("/var/www/%s", domain)).Run()
	}

	// === 5. GENERATE CONFIG NGINX ===
	// Baca template config Nginx
	tplPath := filepath.Join(cwd, "templates", "nginx_site.tpl")
	tpl, err := template.ParseFiles(tplPath)
	if err != nil {
		return "", fmt.Errorf("gagal baca template nginx: %v", err)
	}

	// Tulis file config ke /etc/nginx/sites-available/
	file, err := os.Create(availablePath)
	if err != nil {
		return "", fmt.Errorf("gagal tulis config (Need Root?): %v", err)
	}

	// Isi data ke template (Domain, Type, Port)
	data := NginxData{Domain: domain, Type: typeSite, Port: port}
	err = tpl.Execute(file, data)
	file.Close() // Close manual sebelum reload
	if err != nil {
		return "", fmt.Errorf("gagal eksekusi template: %v", err)
	}

	// === 6. AKTIFKAN CONFIG (SYMLINK) ===
	// ln -s /etc/nginx/sites-available/... /etc/nginx/sites-enabled/...
	os.Remove(enabledPath) // Hapus symlink lama jika ada
	err = os.Symlink(availablePath, enabledPath)
	if err != nil {
		return "", fmt.Errorf("gagal symlink: %v", err)
	}

	// === 7. RELOAD NGINX ===
	// Restart lebih aman daripada reload untuk memastikan config bersih
	cmd := exec.Command("systemctl", "restart", "nginx")
	if err := cmd.Run(); err != nil {
		return "", fmt.Errorf("gagal restart nginx: %v", err)
	}

	return availablePath, nil
}

// Fungsi Hapus (Include ini juga biar sekalian satu file lengkap)
func RemoveNginxConfig(domain string) error {
	availablePath := fmt.Sprintf("/etc/nginx/sites-available/%s.conf", domain)
	enabledPath := fmt.Sprintf("/etc/nginx/sites-enabled/%s.conf", domain)
	webRoot := fmt.Sprintf("/var/www/%s", domain)

	// Hapus Symlink
	os.Remove(enabledPath)
	// Hapus File Config Asli
	os.Remove(availablePath)
	// Hapus Folder Website (Hati-hati, data hilang permanen!)
	os.RemoveAll(webRoot)

	// Restart Nginx
	exec.Command("systemctl", "restart", "nginx").Run()

	return nil
}
